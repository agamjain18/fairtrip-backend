name: Deploy Backend (Simple)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          # 1. Update system and install dependencies
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv git nginx
          
          # 2. Project Directory Setup
          PROJECT_DIR="/home/${{ secrets.SERVER_USER }}/fairtrip-backend"
          if [ ! -d "$PROJECT_DIR" ]; then
            git clone https://github.com/agamjain18/fairtrip-backend.git "$PROJECT_DIR"
          fi
          
          cd "$PROJECT_DIR"
          git fetch origin main
          git reset --hard origin/main
          
          # 3. Python Environment Setup
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # 4. Environment Configuration
          echo "MONGODB_URI=${{ vars.MONGODB_URI }}" > .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "DATABASE_NAME=fairshare" >> .env
          echo "DATABASE_URL=${{ vars.MONGODB_URI }}" >> .env
          
          # 5. Systemd Service Configuration
          # Update the WorkingDirectory in the service file dynamically
          sed -i "s|WorkingDirectory=.*|WorkingDirectory=$PROJECT_DIR|g" fairtrip-backend.service
          sed -i "s|Environment=\"PATH=.*|Environment=\"PATH=$PROJECT_DIR/venv/bin\"|g" fairtrip-backend.service
          sed -i "s|ExecStart=.*|ExecStart=$PROJECT_DIR/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000|g" fairtrip-backend.service
          sed -i "s|User=.*|User=${{ secrets.SERVER_USER }}|g" fairtrip-backend.service
          
          sudo cp fairtrip-backend.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl enable fairtrip-backend
          sudo systemctl restart fairtrip-backend
          
          # 6. Nginx Configuration
          sudo cp nginx-fairtrip.conf /etc/nginx/sites-available/fairtrip
          sudo ln -sf /etc/nginx/sites-available/fairtrip /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          # Test and reload Nginx
          sudo nginx -t && sudo systemctl reload nginx
